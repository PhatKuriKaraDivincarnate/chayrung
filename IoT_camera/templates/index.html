<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi√°m S√°t Ch√°y R·ª´ng</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    body {
        font-family: Arial, sans-serif;
        text-align: center;
        background-color: #f4f4f4;
    }
    .container {
        width: 80%;
        margin: auto;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
    }
    img {
        max-width: 100%;
        height: auto;
        border: 2px solid black;
    }
    canvas {
        margin-top: 20px;
        width: 80% !important;   /* ƒêi·ªÅu ch·ªânh chi·ªÅu r·ªông bi·ªÉu ƒë·ªì */
        height: 300px !important; /* ƒêi·ªÅu ch·ªânh chi·ªÅu cao bi·ªÉu ƒë·ªì */
    }
    .status {
        font-size: 24px;
        font-weight: bold;
    }
    .safe {
        color: green;
    }
    .fire {
        color: red;
    }
</style>

</head>
<body>
    <div class="container">
        <h1>H·ªá Th·ªëng Gi√°m S√°t Ch√°y R·ª´ng</h1>

        <h3>H√¨nh ·∫£nh m·ªõi nh·∫•t t·ª´ camera:</h3>
        <img id="latestImage" src="/latest-image" alt="ƒêang t·∫£i ·∫£nh...">

        <h3>Tr·∫°ng th√°i ch√°y: <span id="fireStatus" class="status">ƒêang t·∫£i...</span></h3>

        <h3>L·ªãch s·ª≠ ph√°t hi·ªán ch√°y</h3>
        <canvas id="fireChart"></canvas>

        <h3>S·ªë l·∫ßn ch√°y theo th√°ng</h3>
        <canvas id="fireChartMonthly"></canvas>
    </div>

    <script>
        function updateImage() {
            document.getElementById("latestImage").src = "/latest-image?" + new Date().getTime();
        }

        function fetchLatestFireStatus() {
            fetch('/latest-fire-status')
                .then(response => response.json())
                .then(data => {
                    let fireStatusElement = document.getElementById('fireStatus');
                    if (data.fire_status === 1) {
                        fireStatusElement.textContent = 'üî• Ch√°y!';
                        fireStatusElement.className = 'status fire';
                    } else {
                        fireStatusElement.textContent = '‚úÖ An to√†n';
                        fireStatusElement.className = 'status safe';
                    }
                })
                .catch(error => console.error('L·ªói l·∫•y tr·∫°ng th√°i ch√°y:', error));
        }

        async function loadFireHistory() {
    try {
        let response = await fetch('/fire-history');
        let data = await response.json();

        if (data.error) {
            console.error("L·ªói t·∫£i d·ªØ li·ªáu:", data.error);
            return;
        }

        // Gi·ªõi h·∫°n d·ªØ li·ªáu trong 24 gi·ªù (ho·∫∑c m·ªôt kho·∫£ng th·ªùi gian kh√°c)
        const currentTime = new Date();
        const dayAgo = new Date(currentTime.getTime() - 24 * 60 * 60 * 1000);  // L·∫•y d·ªØ li·ªáu trong 24 gi·ªù qua
        const filteredTimes = [];
        const filteredStatuses = [];

        // L·ªçc d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian 24 gi·ªù
        data.times.forEach((time, index) => {
            const recordTime = new Date(time);
            if (recordTime >= dayAgo) {
                filteredTimes.push(time);
                filteredStatuses.push(data.statuses[index]);
            }
        });

        // Bi·ªÉu ƒë·ªì l·ªãch s·ª≠ ph√°t hi·ªán ch√°y (bar chart)
        const ctx = document.getElementById('fireChart').getContext('2d');
        const fireChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: filteredTimes.map(time => {
                    const date = new Date(time);
                    return `${date.getHours()}:${date.getMinutes()}`;
                }),
                datasets: [{
                    label: 'Tr·∫°ng th√°i ch√°y (1: Ch√°y, 0: Kh√¥ng ch√°y)',
                    data: filteredStatuses,
                    backgroundColor: filteredStatuses.map(status => status === 1 ? 'rgba(255, 99, 132, 0.6)' : 'rgba(54, 162, 235, 0.6)'),
                    borderColor: filteredStatuses.map(status => status === 1 ? 'rgba(255, 99, 132, 1)' : 'rgba(54, 162, 235, 1)'),
                    borderWidth: 2,
                    hoverBackgroundColor: filteredStatuses.map(status => status === 1 ? 'rgba(255, 99, 132, 0.8)' : 'rgba(54, 162, 235, 0.8)'),
                    hoverBorderColor: filteredStatuses.map(status => status === 1 ? 'rgba(255, 99, 132, 1)' : 'rgba(54, 162, 235, 1)')
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        ticks: {
                            autoSkip: true,
                            maxTicksLimit: 8  // Gi·ªõi h·∫°n m·ªëc th·ªùi gian tr√™n tr·ª•c X
                        },
                        title: {
                            display: true,
                            text: 'Th·ªùi gian (24 gi·ªù)',
                            font: { size: 14, weight: 'bold', family: 'Arial' },
                            color: '#333'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        suggestedMax: 1,
                        title: {
                            display: true,
                            text: 'Tr·∫°ng th√°i ch√°y',
                            font: { size: 14, weight: 'bold', family: 'Arial' },
                            color: '#333'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.7)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        callbacks: {
                            label: function(tooltipItem) {
                                return tooltipItem.raw === 1 ? 'Ch√°y' : 'Kh√¥ng ch√°y';
                            }
                        }
                    }
                },
                elements: {
                    bar: {
                        borderRadius: 5
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeInOutQuad'
                }
            }
        });

        // Bi·ªÉu ƒë·ªì ch√°y theo th√°ng (bar chart) - kh√¥ng thay ƒë·ªïi ·ªü ƒë√¢y
        const ctxMonthly = document.getElementById('fireChartMonthly').getContext('2d');
        const months = [];
        const monthlyFires = [];

        // T√≠nh s·ªë l·∫ßn ch√°y trong m·ªói th√°ng
        data.times.forEach((time, index) => {
            const date = new Date(time);
            const month = `${date.getMonth() + 1}-${date.getFullYear()}`;
            const status = data.statuses[index];

            if (!months.includes(month)) {
                months.push(month);
                monthlyFires.push(status === 1 ? 1 : 0);  // N·∫øu ch√°y th√¨ ƒë·∫øm 1
            } else {
                const monthIndex = months.indexOf(month);
                if (status === 1) {
                    monthlyFires[monthIndex]++;
                }
            }
        });

        const fireChartMonthly = new Chart(ctxMonthly, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [{
                    label: 'S·ªë l·∫ßn ch√°y theo th√°ng',
                    data: monthlyFires,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    hoverBackgroundColor: 'rgba(54, 162, 235, 0.8)',
                    hoverBorderColor: 'rgba(54, 162, 235, 1)',
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        autoSkip: true,
                        maxTicksLimit: 12,
                        title: {
                            display: true,
                            text: 'Th√°ng',
                            font: { size: 14, weight: 'bold', family: 'Arial' },
                            color: '#333'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'S·ªë l·∫ßn ch√°y',
                            font: { size: 14, weight: 'bold', family: 'Arial' },
                            color: '#333'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.7)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        callbacks: {
                            label: function(tooltipItem) {
                                return tooltipItem.raw;
                            }
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeInOutQuad'
                }
            }
        });

    } catch (error) {
        console.error("L·ªói khi t·∫£i bi·ªÉu ƒë·ªì:", error);
    }
}
        setInterval(updateImage, 5000);
        setInterval(fetchLatestFireStatus, 5000);
        loadFireHistory();
    </script>
</body>
</html>
